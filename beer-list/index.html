<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="css/baas.css" type="text/css">
<meta name="viewport" content="width=device-width">

<script src="js/beer.js"></script>
<script src="js/underscore.js"></script>
<script src="js/jquery.js"></script>
<script src="js/backbone.js"></script>
<script src="js/q.js"></script>
<script src="js/baas-1.1.3.js"></script>
<script src="js/jquery.nestedAccordion.js"></script>

<title>맥주 리스트</title>


<script>

$(document).ready(function(){

	/* $.fn.accordion.defaults.container = false; 
	$("#acc1").accordion({
		el: ".h", 
		head: "h4, h5", 
		next: "div", 
		initShow : "div.outer:eq(1)",
		event: "click"
	});
	$("h5").click(function() {
		$("#result").html("");
		$("#error").html("");
		$("#source").html("");
	});
	 */
	var promise = Q.resolve();
    Baas.API_KEY = '0b1b2899-0ca4-4e24-beee-1af8de2294d4';
    

    var table = Baas.Table.create('beer_list');
    table.fetch({
    	success : function(model, response){
    		onFetch(response)
    	},
    	error : function(model, response){
    		console.log('error : ' + response.responseText);
    	}
    });
});

var onFetch = function(response) {
	var mainDiv = $('#main');
	var size = response.results.length;
	
	for(var i = 0 ; i < size ; i++) {
		var innerDiv = $('<div id="inner-'+i+'"></div>');
		var rating = parseFloat(response.results[i].rating);
		innerDiv.append("<img src='"+response.results[i].imageAddress+"' />");
		innerDiv.append("<p>"+response.results[i].bearName+"</p>");
		innerDiv.append("<p id='star-"+i+"'>별점 : "+rating.toFixed(1)+" ("+response.results[i].counting+")</p>");
		innerDiv.append("<input id='object-id-"+i+"' type='hidden' value='"+response.results[i].objectId+"'>");
		innerDiv.append("<input id='rating-"+i+"' type='hidden' value='"+response.results[i].rating+"'>");
		innerDiv.append("<input id='counting-"+i+"' type='hidden' value='"+response.results[i].counting+"'>");
		
		innerDiv.append('<select id="input-score-'+i+'">'
				+'<option value="5">5</option>'
			    +'<option value="4">4</option>'
			    +'<option value="3">3</option>'
			    +'<option value="2">2</option>'
			    +'<option value="1">1</option>'
			+'</select>');
		innerDiv.append("<input type='button' value='평가' onClick='onInsert("+i+");'>");

		mainDiv.append(innerDiv);
	}
}

var onInsert = function(i) {
	
	var objectId = $('#object-id-'+i).val();
	var rating = $('#rating-'+i).val();
	var counting = $('#counting-'+i).val();
	var score = $('#input-score-'+i).val();

	rating = parseFloat(rating);
	counting = parseFloat(counting);
	score = parseFloat(score);

	rating = ((rating*counting + score)/(counting+1)).toFixed(5);
	
	counting = counting + 1;
	
	var obj = {};
	obj['rating'] = rating+'';
	obj['counting'] = counting+'';
	obj['objectId'] = objectId;
	
	var baasObj = Baas.Object.create('beer_list', obj);
	baasObj.save({
		success : function(model, response){
			console.log(JSON.stringify(response));
		},
		error : function(model, response){
			console.log(response.responseText);
		}
	});
	

	$('#rating-'+i).val(parseFloat(rating).toFixed(1));
	$('#counting-'+i).val(counting);
	$('#star-0').html("별점 : "+parseFloat(rating).toFixed(1)+" ("+counting+")")
}
</script>
</head>
<body>
<div id="main"> 
</div>

</body>
</html>